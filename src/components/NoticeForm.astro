---
/**
 * Componente: Formulario de Aviso
 * Maneja tanto ausencias como cambios de dieta
 */

interface Props {
    type: "ausencia" | "dieta";
    onClose?: string; // ID del modal a cerrar o función JS (aquí usaremos string para script simple)
}

const { type } = Astro.props;

const title =
    type === "ausencia" ? "Notificar Ausencia" : "Solicitar Cambio de Dieta";
const dateLabel =
    type === "ausencia" ? "Fecha de ausencia" : "Fecha del cambio";
const commentLabel =
    type === "ausencia" ? "Motivo (opcional)" : "Detalles del cambio";
const commentPlaceholder =
    type === "ausencia"
        ? "Ej: Cita médica, enfermedad..."
        : "Ej: Dieta blanda por dolor de estómago...";
const buttonText =
    type === "ausencia" ? "Notificar Ausencia" : "Solicitar Cambio";
const formId = `form-${type}`;
---

<form id={formId} class="flex flex-col gap-4">
    <input type="hidden" name="type" value={type} />

    <div>
        <label
            for={`${formId}-date`}
            class="block text-sm font-medium text-gray-700 mb-1"
        >
            {dateLabel}
        </label>
        <input
            type="date"
            id={`${formId}-date`}
            name="date"
            required
            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
        />
        <p class="text-xs text-gray-400 mt-1">
            Para rangos, indicar en comentarios
        </p>
    </div>

    <div>
        <label
            for={`${formId}-comment`}
            class="block text-sm font-medium text-gray-700 mb-1"
        >
            {commentLabel}
            {type === "dieta" && <span class="text-red-500">*</span>}
        </label>
        <textarea
            id={`${formId}-comment`}
            name="comment"
            required={type === "dieta"}
            placeholder={commentPlaceholder}
            rows="3"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        ></textarea>
    </div>

    <button
        type="submit"
        class={`w-full py-3.5 px-4 rounded-xl text-white font-medium text-lg shadow-sm transition-all active:scale-[0.98] ${
            type === "ausencia"
                ? "bg-red-600 hover:bg-red-700 shadow-red-200"
                : "bg-green-600 hover:bg-green-700 shadow-green-200"
        }`}
    >
        {buttonText}
    </button>
</form>

<script define:vars={{ formId }}>
    const form = document.getElementById(formId);

    if (form) {
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            // Simulación de envío
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            console.log("Enviando aviso:", data);

            // Feedback visual temporal
            const btn = form.querySelector("button");
            const originalText = btn.textContent;

            btn.textContent = "Enviado correctamente ✓";
            btn.disabled = true;
            btn.classList.add("opacity-75");

            // TODO: Conectar con Supabase aquí

            setTimeout(() => {
                // Recargar para ver el nuevo aviso en la lista (mock)
                // En una app real, actualizaríamos el estado o redirigiríamos
                window.location.reload();
            }, 1000);
        });
    }
</script>
